# 如何设计一个秒杀系统

## 架构原则

### 数据要尽量少，减少CPU消耗

- 用户请求的数据能少就少
  - 上传给系统的数据
  - 系统返回给用户的数据
- 系统依赖的数据能少就少
  - 包括和后台服务及数据库打交道的数据

### 请求数要尽量少

- css/javaScript，图片，ajax请求等“额外请求”尽量减少

### 路径要尽量短，减少节点消耗

路径指的是：用户从发出请求到返回数据这个过程中，需要经过的中间节点数。

### 依赖要尽量少，减少加载时间

### 不要有单点，要有备份

- 服务无状态化，即避免服务的状态和机器绑定
- 数据冗余多个备份的方式解决存储服务单点问题

## 如何做好动静分离

### 什么是动静数据

- “动态数据”和“静态数据”的主要区别就是看页面中输出的数据是否和URL、浏览者、地域相关，以及是否含有cookie等私密数据。

### 如何对静态数据做缓存

- 把静态数据缓存到离用户最近的地方
  - 用户浏览器
  - CDN
  - 服务端的cache中
- 静态化改造就是直接缓存http连接
  - 例如：web代理服务器直接根据用户请求URL，直接取出对应的http响应头和响应体然后直接返回数据
- 让谁来缓存静态数据也很重要
  - web服务器更适合处理大并发静态文件请求

### 如何做动静分离的改造

- URL唯一化
- 分离浏览者的相关因素
  - 是否登陆
  - 登陆身份
- 分离时间因素
- 异步化地域因素
- 去掉cookie
  - 缓存的静态数据中不包含cookie
- 动态数据处理
  - ESI/SSI方案
    server side include
    - web代理服务器上做动态数据请求，并将请求插入到静态页面中，返回用户端的数据是完整的。对服务端性能有影响，但是用户体验好。
  - CSI方案
    client side include
    - 客户端单独发起异步请求，从服务端获取动态数据。服务端性能更佳，但是用户端页面可能会延时，体验稍差。

### 动静分离的架构方案

- 实体单机部署
  - 将虚拟机改为实体机，以增大cache的容量，采用一致性hash分组方式提升命中率
  - 优点
    - 没有网络瓶颈，而且能使用大内存
    - 既能提升命中率，又能减少gzip压缩
    - 减少cache失效的压力，采用定时失效方式
  - 缺点
    - 造成CPU浪费
- 统一cache 层
  - 将单机的cache统一分离出来，形成一个单独的cache集群
  - 优点
    - 减少多个应用接入时使用cache的成本，接入的应用只需维护自己的系统，不需要单独维护cache
    - 更易维护
    - 可以共享内存，最大化利用内存，不同系统之间的内存可以动态切换，从而有效应对各种攻击
  - 缺点
    对cache做hash分组，可解决这些问题
    - cache层内部交换网络成为瓶颈
    - 缓存服务器的网卡也是瓶颈
    - 机器少风险大，挂掉一台会影响很大一部分缓存
- CDN
  - 将cache进一步移到CDN上
    - 失效问题
      - 需要保证CDN在秒级时间内，分布在全国的CDN同时主动失效
    - 命中率问题
    - 发布更新问题
  - 特性
    - 整个页面缓存在用户浏览器中
    - 如果强刷整个页面，也会请求CDN
    - 实际有效请求，只是用户对“刷新秒杀”按钮的点击

## 针对性处理系统的“热点数据”

### 什么是“热点”

- 热点操作
  - 大量的刷新、添加购物车等“读请求”和“写请求”。写请求的瓶颈一般在存储层，优化的思路是根据CAP理论做平衡
- 热点数据
  - 静态热点数据
    - 能够提前预测的热点数据，通过报名、分析历史数据、购物车记录等发现的数据
  - 动态热点数据
    - 不能提前预测的，系统在运行过程中临时产生的。

### 发现热点数据

- 静态热点数据可以通过商业手段获取，通过报名的方式增加成本，实时性较差，不太灵活；也可以使用技术手段提前预测。
- 动态热点数据，实现热点的动态发现功能

### 热点数据处理

- 优化
  - “临时”缓存热点数据，队列暂时缓存数秒，使用LRU淘汰算法替换
- 限制
  - 例如对被访问的商品ID做一致性hash，根据hash做分桶，把热点商品限制在一个请求队列中，防止热点商品占用太多服务器资源，其他请求得不到服务器的处理
- 隔离
  - 业务隔离
    - 报名参加活动，从技术上提前做好预热
  - 系统隔离
    - 分组部署的方式，秒杀申请单独的域名
  - 数据隔离
    - 启用单独的cache集群或者数据库存放热点数据

## 流量削峰怎么做

### 优点

- 让服务端处理变得更加平稳
- 节省服务器的资源成本
- 针对秒杀，削峰本质上是更多的延缓用户请求的发出，减少和过滤无效的请求

### 操作思路

- 排队，把一步操作变为两步操作
  - 消息队列
  - 利用线程池加锁等待
  - 先进先出、先进后出等内存排队算法实现
  - 把请求序列化到文件中，再顺序读取文件来恢复请求
- 答题，增加购买的复杂度
  - 目的
    - 防止部分买家使用秒杀器作弊
    - 延缓请求，对请求流量进行削峰
  - 秒杀答题系统
    - 逻辑：用户提交的答案和题目对应的答案进行比较，通过进行下一步逻辑，否则就失败；对提交答案的时间做限制
    - 实现
      - 题库生成模块
      - 题库推送模块
        - 每次请求的题目是唯一的，防止答题作弊
      - 题库的图片生成模块
        - 图片增加干扰因素，防止机器作弊，提前把生成的图片推送到CDN上，防止图片加载慢
- 分层过滤
  - 核心
    - 在不同的层次上尽可能过滤掉无效的请求，让“漏斗”末端的请求是有效的请求
  - 分层校验基本原则
    - 将动态请求的读数据缓存在web端，过滤掉无效的读数据
    - 对读数据不做强一致性校验，减少因为校验产生瓶颈问题
    - 对写数据进行基于时间的合理分片，过滤掉过期的失效请求
    - 对写请求做限流保护，将超出系统承载能力的请求过滤掉
    - 对写数据进行强一致性校验，只保留最后有效的数据

## 系统性能

### 影响性能的因素

减少CPU的执行时间，线程数不是越多越好，线程越多线程切换成本越高。

- 每秒请求数QPS
- 响应时间RT

### 如何发现瓶颈

主要针对CPU的消耗

- JProfiler，Yorkist
- 海量请求，页面较大可能出现网络瓶颈
- QPS达到极限的时候，CPU利用率是不是超过了95%，没有则CPU还有提升空间

### 如何优化系统

- 减少编码
- 减少序列化
- 并发读优化

## 减库存设计的核心逻辑

### 减库存的方式

- 下单减库存
- 付款减库存
- 预扣库存

## 准备plan B

---

